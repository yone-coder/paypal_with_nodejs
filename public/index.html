<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PPCP Advanced</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/minstyle.io@2.0.1/dist/css/minstyle.io.min.css">
    <style>
      .hide {
        display: none !important;
      }
      .spinner-container {
        width: 100px;
        height: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .div_input {
        display: inline-block;
        height: 40px;
        width: 100%;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        -webkit-box-shadow: none;
        box-shadow: none;
        font-size: 0.98rem;
        background-color: rgba(var(--main-bg), 1);
        border: 2px solid rgba(var(--default-border-color), 1);
        border-radius: var(--default-border-radius);
        margin: 0;
        padding: 0 0.8rem;
      }
      .spinner {
        border: 8px solid rgba(0, 0, 0, 0.1);
        border-top-color: lightblue;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .payment-section {
        margin-top: 20px;
        padding: 20px;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.05);
      }
      .error-message {
        color: #ff6b6b;
        text-align: center;
        margin: 10px 0;
      }
      .success-message {
        color: #51cf66;
        text-align: center;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm"></div>
        <div class="col-sm">
          <h2 class="ms-text-center">AI-Generated NFT Bored Ape</h2>
          <div class="ms-text-center pb-2">
            <div class="ms-label ms-large ms-action2 ms-light">$100.00 USD</div>
          </div>
          
          <div id="alerts" class="ms-text-center"></div>
          
          <div id="loading" class="spinner-container ms-div-center">
            <div class="spinner"></div>
          </div>
          
          <div id="content" class="hide">
            <div class="ms-card ms-fill">
              <div class="ms-card-content">
                <img src="https://cdn.discordapp.com/attachments/1060825015681028127/1076385063903694908/rauljr7_3d_e83fed6a-69aa-4a6a-b0ec-928edd57aecf.png" 
                     style="width:100%; max-width:400px; height:auto;">
              </div>
            </div>
            
            <div class="payment-section">
              <h3 class="ms-text-center">Choose Payment Method</h3>
              
              <!-- PayPal Buttons will be inserted here -->
              <div id="paypal-buttons" style="margin: 20px 0;"></div>
              
              <div style="text-align: center; margin: 20px 0;">
                <strong>OR</strong>
              </div>
              
              <!-- Credit Card Form -->
              <form id="card-form" class="ms-form-group">
                <h4>Pay with Credit Card</h4>
                <div style="margin-bottom: 15px;">
                  <label for="card-number">Card Number</label>
                  <div class="div_input" id="card-number"></div>
                </div>
                
                <div class="row">
                  <div class="col-md mb-2">
                    <label for="expiration-date">Expiration Date</label>
                    <div id="expiration-date" class="div_input"></div>
                  </div>
                  <div class="col-md mb-2">
                    <label for="cvv">Security Code</label>
                    <div id="cvv" class="div_input"></div>
                  </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                  <label for="email">Email</label>
                  <input value="" placeholder="username@email.com" type="email" id="email" class="div_input" required>
                </div>
                
                <div>
                  <input class="ms-fullwidth mt-2 ms-medium" type="submit" value="Purchase" id="card-submit">
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="col-sm"></div>
      </div>
      <footer style="margin-top:50px" class="ms-footer">
        Footer Intentionally left empty :)
      </footer>
    </div>

    <script>
      // Configuration - Update these with your actual values
      const SERVER_URL = 'https://your-render-app-name.onrender.com'; // Update this with your Render URL
      const PAYPAL_CLIENT_ID = 'REPLACE_WITH_YOUR_CLIENT_ID'; // Your PayPal client ID
      const CURRENCY = 'USD';
      const INTENT = 'capture';

      // State variables
      let order_id;
      let paypal_buttons;
      let paypal_hosted_fields;

      // Utility functions
      const loadScript = (attributes) => {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          for (const [key, value] of Object.entries(attributes)) {
            script.setAttribute(key, value);
          }
          document.head.appendChild(script);
          script.addEventListener('load', resolve);
          script.addEventListener('error', reject);
        });
      };

      const showError = (message) => {
        document.getElementById('alerts').innerHTML = `
          <div class="ms-alert ms-action2 ms-small">
            <span class="ms-close" onclick="this.parentElement.remove()"></span>
            <p>${message}</p>
          </div>
        `;
      };

      const showSuccess = (orderDetails) => {
        const intentObject = INTENT === 'authorize' ? 'authorizations' : 'captures';
        const payment = orderDetails.purchase_units[0].payments[intentObject][0];
        const payer = orderDetails.payer;
        
        document.getElementById('alerts').innerHTML = `
          <div class="ms-alert ms-action">
            Thank you ${payer?.name?.given_name || ''} ${payer?.name?.surname || ''} 
            for your payment of ${payment.amount.value} ${payment.amount.currency_code}!
          </div>
        `;

        // Hide payment forms
        document.getElementById('card-form').classList.add('hide');
        document.getElementById('paypal-buttons').classList.add('hide');
      };

      const resetSubmitButton = () => {
        const submitBtn = document.getElementById('card-submit');
        submitBtn.removeAttribute('disabled');
        submitBtn.value = 'Purchase';
      };

      const getClientToken = async () => {
        try {
          const response = await fetch(`${SERVER_URL}/get_client_token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          return await response.text();
        } catch (error) {
          console.error('Error getting client token:', error);
          throw error;
        }
      };

      const createOrder = async () => {
        try {
          const response = await fetch(`${SERVER_URL}/create_order`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ intent: INTENT })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const order = await response.json();
          return order.id;
        } catch (error) {
          console.error('Error creating order:', error);
          throw error;
        }
      };

      const completeOrder = async (orderId, email = null) => {
        try {
          const response = await fetch(`${SERVER_URL}/complete_order`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              intent: INTENT,
              order_id: orderId,
              email: email
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          return await response.json();
        } catch (error) {
          console.error('Error completing order:', error);
          throw error;
        }
      };

      // Initialize PayPal integration
      const initializePayPal = async () => {
        try {
          // Get client token
          const clientToken = await getClientToken();
          
          // Load PayPal SDK
          await loadScript({
            src: `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&enable-funding=venmo&currency=${CURRENCY}&intent=${INTENT}&components=buttons,hosted-fields`,
            'data-client-token': clientToken
          });

          // Hide loading spinner and show content
          document.getElementById('loading').classList.add('hide');
          document.getElementById('content').classList.remove('hide');

          // Initialize PayPal Buttons
          paypal_buttons = paypal.Buttons({
            style: {
              shape: 'rect',
              color: 'gold',
              layout: 'vertical',
              label: 'paypal'
            },
            
            createOrder: createOrder,
            
            onApprove: async (data, actions) => {
              try {
                order_id = data.orderID;
                const orderDetails = await completeOrder(order_id);
                showSuccess(orderDetails);
              } catch (error) {
                console.error('Error in onApprove:', error);
                showError('Payment processing failed. Please try again.');
              }
            },
            
            onCancel: (data) => {
              showError('Payment was cancelled.');
            },
            
            onError: (err) => {
              console.error('PayPal error:', err);
              showError('An error occurred with PayPal. Please try again.');
            }
          });

          paypal_buttons.render('#paypal-buttons');

          // Initialize Hosted Fields (Credit Card)
          if (paypal.HostedFields.isEligible()) {
            paypal_hosted_fields = await paypal.HostedFields.render({
              createOrder: async () => {
                order_id = await createOrder();
                return order_id;
              },
              
              styles: {
                '.valid': { color: 'green' },
                '.invalid': { color: 'red' },
                'input': {
                  'font-size': '16pt',
                  'color': '#ffffff'
                }
              },
              
              fields: {
                number: {
                  selector: '#card-number',
                  placeholder: '4111 1111 1111 1111'
                },
                cvv: {
                  selector: '#cvv',
                  placeholder: '123'
                },
                expirationDate: {
                  selector: '#expiration-date',
                  placeholder: 'MM/YY'
                }
              }
            });

            // Handle credit card form submission
            document.getElementById('card-form').addEventListener('submit', async (event) => {
              event.preventDefault();
              
              const submitBtn = document.getElementById('card-submit');
              submitBtn.setAttribute('disabled', '');
              submitBtn.value = 'Processing...';
              
              try {
                await paypal_hosted_fields.submit({
                  cardholderName: 'John Doe', // You can make this dynamic
                  billingAddress: {
                    streetAddress: '123 Main St',
                    extendedAddress: '',
                    region: 'CA',
                    locality: 'San Jose',
                    postalCode: '95131',
                    countryCodeAlpha2: 'US'
                  }
                });
                
                const email = document.getElementById('email').value;
                const orderDetails = await completeOrder(order_id, email);
                showSuccess(orderDetails);
                
              } catch (error) {
                console.error('Error processing card payment:', error);
                showError('Card payment failed. Please check your details and try again.');
                resetSubmitButton();
              }
            });
          } else {
            console.log('Hosted Fields not eligible');
            document.getElementById('card-form').innerHTML = '<p>Credit card payments are not available at this time.</p>';
          }

        } catch (error) {
          console.error('Error initializing PayPal:', error);
          document.getElementById('loading').classList.add('hide');
          showError('Failed to initialize payment system. Please refresh the page and try again.');
        }
      };

      // Start the application
      document.addEventListener('DOMContentLoaded', initializePayPal);
    </script>
  </body>
</html>